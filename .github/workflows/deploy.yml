name: Deploy SL Accounting LMS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH Password
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            # 0. Stop script immediately if any command fails
            set -e

            # 1. Navigate to project root
            cd /var/www/sl-accounting

            # 2. Fix Permissions FIRST so the git user can write
            # (Allows the current SSH user to take ownership back from www-data)
            echo "--- Reclaiming Permissions ---"
            sudo chown -R $USER:$USER /var/www/sl-accounting

            # 3. Force Git Update (Safety Nuke)
            # This discards local server changes and forces it to match GitHub
            echo "--- Pulling Latest Code ---"
            git fetch --all
            git reset --hard origin/main

            # 4. Setup API (Backend)
            echo "--- Setup API ---"
            cd apps/api
            npm ci  # 'ci' is faster and cleaner than 'install' for deployments
            # If you use PM2, reload it gracefully
            pm2 reload lms-api || pm2 restart lms-api

            # 5. Setup Web (Frontend)
            echo "--- Setup Web ---"
            cd ../web
            npm ci
            
            # IMPORTANT: Ensure your .env file on the server has the new BANK JSON string!
            npm run build

            # 6. Fix Permissions for Nginx (Final Step)
            echo "--- Finalizing Permissions ---"
            cd /var/www/sl-accounting
            sudo chown -R www-data:www-data /var/www/sl-accounting
            sudo chmod -R 755 /var/www/sl-accounting

            # 7. Restart Nginx to serve new static assets
            sudo systemctl reload nginx
            
            echo "--- Deployment Complete ---"